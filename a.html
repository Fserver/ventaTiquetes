<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Page Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/cleave.min.js"></script>
    <script src="js/numeral.min.js"></script>
    <script src="js/moment.js"></script>

</head>

<body>
    <h1 id="hora">Cargando...</h1>

    <form name="formulario" onSubmit="enviarDatos(); return false">

        <h4>Nombre de Titular</h4>
        <input id="nombre" type="text" name="nombre">

        <h4>Persona</h4>
        <select id="tipoTiquete">
            <option value='0'>Seleccione</option>
        </select>

        <h4>Tipo de Tiquete</h4>
        <div>
            <input type="radio" id="pasaje1" name="contact" value="1">
            <label for="contactChoice2">PASAJE COMPLETO (ida + Regreso)</label>

            <input type="radio" id="pasaje2" name="contact" value="2">
            <label for="contactChoice1">PASAJE SOLO ida</label>
        </div>

        <h4>Cantidad Acompañantes</h4>
        <input type="number" id="cantidadAcompanantes" min="0" max="10" maxlength="2" value="0">

        <h4>Costo total:</h4>
        <p id="costoTotal">0</p>

        <hr>

        <h4>Pago en efectivo</h4>
        <input class="my-input" name="efectivo" id="efectivo" value="0">

        <h4>Cambio</h4>
        <p id="cambio">0</p>

        <br>
        <input id="registrar" type="submit" value="ok">

    </form>

    <div id="resultado"></div>
    <div id="r2"></div>







    <script>

        var costoTiquete = 0;
        var cantidadPersonas = 0;

        $(document).ready(function () {

            cargarCostos();

            setInterval(() => {

                $('#hora').text(moment().format('YYYY-M-D H:mm:ss'));

            }, 1000);
        });

        $(document).change(function () {

            costoT();
            generarCambio();
            valor();

        });

        $("#cantidadAcompanantes").click(function () {
            valor();
        });

        function costoT() {
            h = $('#tipoTiquete').val();
            if (h > 0) {
                costoTiquete = respuesta[h - 1].id;
                console.log('C: ' + costoTiquete);
            } else costoTiquete = 0;
        }

        function valor() {

            function x() {
                cantidadPersonas = $('#cantidadAcompanantes').val();
                if (cantidadPersonas == 0) {
                    return cantidad = 1;
                } else {
                    temp = $('#cantidadAcompanantes').val();
                    return cantidad = parseInt(temp) + 1;
                }
            }

            if ($('#pasaje1').is(':checked')) {
                var aux = costoTiquete * x();
                $('#costoTotal').text(numeral(aux * 2).format('$ 0,0'));
            } else {
                var aux = costoTiquete * x();
                $('#costoTotal').text(numeral(aux).format('$ 0,0'));
            }
        }

        function generarCambio() {

            v1 = numeral($('#efectivo').val()).value();
            v2 = numeral($('#costoTotal').text()).value();

            if (v1 > v2) {
                t = v1 - v2;
                // console.log(t);
                t2 = numeral(t).format('$ 0,0');
                $('#cambio').text(t2);
            } else $('#cambio').text("Ingrese el valor en efectivo pagado por el turista");
        }

        var cleave = new Cleave('.my-input', {
            numeral: true,
            prefix: '$'
        });

        function objetoAjax() {
            var xmlhttp = false;
            try {
                xmlhttp = new ActiveXObject("Msxml2.XMLHTTP");
            } catch (e) {

                try {
                    xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
                } catch (E) {
                    xmlhttp = false;
                }
            }

            if (!xmlhttp && typeof XMLHttpRequest != 'undefined') {
                xmlhttp = new XMLHttpRequest();
            }
            return xmlhttp;
        }

        function enviarDatos() {

            //Recogemos los valores introducimos en los campos de texto
            equipo = document.formulario.nombre.value;
            equipo2 = $('#hora').text();

            //instanciamos el objetoAjax
            ajax = objetoAjax();

            //Abrimos una conexión AJAX pasando como parámetros el método de envío, y el archivo que realizará las operaciones deseadas
            ajax.open("POST", "a.php", true);

            //cuando el objeto XMLHttpRequest cambia de estado, la función se inicia
            ajax.onreadystatechange = function () {

                //Cuando se completa la petición, mostrará los resultados
                if (ajax.readyState == 4) {

                    //El método responseText() contiene el texto de nuestro 'consultar.php'. Por ejemplo, cualquier texto que mostremos por un 'echo'
                    respuesta = (ajax.responseText)
                    $('#resultado').html(respuesta);
                }
            }

            //Llamamos al método setRequestHeader indicando que los datos a enviarse están codificados como un formulario.
            ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

            //enviamos las variables a 'consulta.php'
            ajax.send("&nombre=" + equipo + "&hora=" + equipo2)

        }

        function cargarCostos() {
            ajax = objetoAjax();
            ajax.open("POST", "c.php", true);
            ajax.onreadystatechange = function () {
                if (ajax.readyState == 4) {
                    respuesta = JSON.parse(ajax.responseText)

                    contador = -1;
                    respuesta.forEach(element => {
                        contador++;
                        $('#tipoTiquete').append("<option value='" + respuesta[contador].id + "'> " + respuesta[contador].nombres + " </option>");
                    });

                    $('#r2').text();
                }
            }
            ajax.send();
        }
    </script>
</body>

</html>